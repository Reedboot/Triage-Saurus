rules:
  - id: terraform-hardcoded-keyvault-secret
    message: |
      Hardcoded secret value in Key Vault resource.
      Secret values should be provided via variables, data sources, or generated resources.
      Hardcoded secrets in code pose security risks and are difficult to rotate.
    severity: ERROR
    languages: [terraform, hcl]
    patterns:
      - pattern: |
          resource "azurerm_key_vault_secret" "$NAME" {
            ...
            value = "$LITERAL"
            ...
          }
      - metavariable-regex:
          metavariable: $LITERAL
          regex: ^(?!(var\.|data\.|azurerm_|random_|tls_|null_resource\.|local\.|module\.)).*
      - pattern-not: |
          resource "azurerm_key_vault_secret" "$NAME" {
            ...
            value = var.$VAR
            ...
          }
      - pattern-not: |
          resource "azurerm_key_vault_secret" "$NAME" {
            ...
            value = data.$DATA
            ...
          }
      - pattern-not: |
          resource "azurerm_key_vault_secret" "$NAME" {
            ...
            value = random_$TYPE.$NAME.$ATTR
            ...
          }
    metadata:
      category: security
      subcategory: [secrets, hardcoded]
      cwe: CWE-798
      confidence: HIGH
      likelihood: HIGH
      impact: HIGH
      technology: [terraform, azure]
      remediation: |
        Use variable or generated secret:
        - value = var.secret_value
        - value = random_password.example.result
        - value = data.azurerm_key_vault_secret.source.value
