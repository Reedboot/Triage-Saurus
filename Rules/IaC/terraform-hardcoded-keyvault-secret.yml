rules:
  - id: terraform-hardcoded-keyvault-secret
    message: |
      Hardcoded secret value in Key Vault resource.
      Secret values should be provided via variables, data sources, or generated resources.
      Hardcoded secrets in code pose security risks and are difficult to rotate.
      
      Detected literal string value instead of reference to: var.*, data.*, random_*, 
      azurerm_*, azuread_*, or other resource/data source.
    severity: ERROR
    languages: [terraform, hcl]
    patterns:
      - pattern: |
          resource "azurerm_key_vault_secret" "$NAME" {
            ...
            value = "$LITERAL"
            ...
          }
      - metavariable-pattern:
          metavariable: $LITERAL
          patterns:
            - pattern-not-regex: ^(var\.|data\.|local\.|module\.)
            - pattern-not-regex: ^(azurerm_|azuread_|random_|tls_|null_resource\.|time_)
            - pattern-not-regex: ^\$\{
    metadata:
      category: security
      subcategory: [secrets, hardcoded]
      cwe: CWE-798
      confidence: HIGH
      likelihood: HIGH
      impact: HIGH
      technology: [terraform, azure]
      remediation: |
        Use variable or generated secret:
        
        # Good: Variable reference
        resource "azurerm_key_vault_secret" "example" {
          value = var.secret_value
        }
        
        # Good: Generated password
        resource "azurerm_key_vault_secret" "example" {
          value = random_password.example.result
        }
        
        # Good: From another resource
        resource "azurerm_key_vault_secret" "example" {
          value = azuread_service_principal_password.sp.value
        }
        
        # Bad: Hardcoded literal
        resource "azurerm_key_vault_secret" "example" {
          value = "MySecretPassword123!"  # ‚ùå DO NOT DO THIS
        }
      notes: |
        This rule detects literal string values in Key Vault secrets.
        Examples that WILL trigger:
        - value = "Th$s$sS3cr3t!"
        - value = "Fred is cool."
        - value = "any-literal-string"
        
        Examples that will NOT trigger (correct usage):
        - value = var.secret_value
        - value = random_password.pw.result
        - value = azurerm_key_vault_secret.source.value
        - value = azuread_service_principal_password.sp.value
        - value = data.azurerm_key_vault_secret.imported.value
