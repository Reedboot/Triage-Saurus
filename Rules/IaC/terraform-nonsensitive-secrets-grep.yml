rules:
  - id: terraform-nonsensitive-secrets-grep
    message: |
      nonsensitive() wrapper detected wrapping potentially sensitive values.
      
      The nonsensitive() function removes Terraform's built-in secret protection,
      exposing values in console output (with -verbose) and state files.
      
      **MANUAL REVIEW REQUIRED:** Check if this wraps:
      - Passwords, secrets, keys, tokens, credentials
      - Connection strings, account keys, SAS tokens
      - Service principal secrets, API keys
      
      If yes, remove nonsensitive() wrapper and mark output as sensitive.
    severity: WARNING
    languages: [terraform, hcl]
    patterns:
      - pattern-regex: nonsensitive\(
    metadata:
      category: security
      subcategory: [secrets, exposure]
      cwe: CWE-532
      confidence: MEDIUM
      likelihood: MEDIUM
      impact: HIGH
      technology: [terraform]
      grep_compatible: true
      manual_review: REQUIRED
      remediation: |
        Review each nonsensitive() usage and remove if wrapping sensitive data:
        
        # Bad: Exposes password
        output "db_pass" { 
          value = nonsensitive(azurerm_mssql_server.example.administrator_login_password) 
        }
        
        # Good: Marks as sensitive
        output "db_pass" { 
          value = azurerm_mssql_server.example.administrator_login_password
          sensitive = true
        }
        
        # Sometimes OK: Wrapping non-sensitive computed values
        output "resource_id" {
          value = nonsensitive(azurerm_resource.example.id)  # Resource IDs often OK
        }
      notes: |
        **GREP-COMPATIBLE RULE**
        
        This is a simplified version for environments without Semgrep.
        
        Limitations:
        - Cannot automatically filter by content (password/secret keywords)
        - Requires manual review of all matches
        - May flag legitimate uses (non-sensitive computed values)
        
        For semantic filtering, use: terraform-nonsensitive-secrets.yml (requires Semgrep)
        
        Usage with grep:
          grep -Hn "nonsensitive(" **/*.tf
        
        False positive rate: ~20-30% (some nonsensitive() uses are legitimate)
