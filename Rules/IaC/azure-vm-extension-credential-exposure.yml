rules:
  - id: azure-vm-extension-credential-exposure
    message: |
      VM extension contains potential credentials in settings or protected_settings.
      Credentials in VM extensions are visible in Azure API responses, ARM templates,
      process command lines, and VM logs. Use Managed Identity or Key Vault references.
    severity: ERROR
    languages: [terraform, hcl]
    patterns:
      - pattern-either:
          - pattern: |
              resource "azurerm_virtual_machine_extension" "$NAME" {
                ...
                settings = <<SETTINGS
                  ...
                  $CRED
                  ...
                SETTINGS
                ...
              }
          - pattern: |
              resource "azurerm_virtual_machine_extension" "$NAME" {
                ...
                protected_settings = <<SETTINGS
                  ...
                  $CRED
                  ...
                SETTINGS
                ...
              }
      - metavariable-regex:
          metavariable: $CRED
          regex: .*(password|secret|key|token|credential|client_id|client_secret|tenant_id).*
    metadata:
      category: security
      subcategory: [secrets, exposure, compute]
      cwe: CWE-798
      confidence: MEDIUM
      likelihood: HIGH
      impact: CRITICAL
      technology: [terraform, azure, vm]
      remediation: |
        Use Managed Identity or Key Vault:
        
        # Option 1: Managed Identity (preferred)
        resource "azurerm_virtual_machine_extension" "example" {
          settings = <<SETTINGS
            {
              "useManagedIdentity": true
            }
          SETTINGS
        }
        
        # Option 2: Key Vault reference
        resource "azurerm_virtual_machine_extension" "example" {
          protected_settings = <<SETTINGS
            {
              "secretUrl": "${azurerm_key_vault_secret.example.id}"
            }
          SETTINGS
        }
      notes: |
        VM extensions are particularly risky because:
        1. Settings visible in Azure Resource Manager API
        2. Commands logged in /var/log/waagent.log
        3. Credentials passed via command line (visible in ps)
        4. ARM template exports include full configuration
        
        Even "protected_settings" are not truly protected from:
        - VM administrator access
        - Azure API enumeration with proper RBAC
        - Process monitoring on the VM itself
