rules:
  - id: terraform-nonsensitive-secrets
    message: |
      nonsensitive() wrapper removes Terraform's built-in secret protection.
      This exposes sensitive values in console output (with -verbose) and state files.
      Remove nonsensitive() wrapper from credential-related values.
    severity: WARNING
    languages: [terraform, hcl]
    patterns:
      - pattern: nonsensitive($VALUE)
      - metavariable-regex:
          metavariable: $VALUE
          regex: .*(password|secret|key|token|credential|connection_string|account_key|sas).*
    metadata:
      category: security
      subcategory: [secrets, exposure]
      cwe: CWE-532
      confidence: MEDIUM
      likelihood: MEDIUM
      impact: HIGH
      technology: [terraform]
      remediation: |
        Remove nonsensitive() wrapper:
        - Before: output "db_pass" { value = nonsensitive(azurerm_mssql_server.example.administrator_login_password) }
        - After: output "db_pass" { value = azurerm_mssql_server.example.administrator_login_password; sensitive = true }
      notes: |
        Risk depends on:
        - Whether verbose output is enabled (requires operator error)
        - State backend security (local vs remote encrypted)
        - Console logging/recording practices
