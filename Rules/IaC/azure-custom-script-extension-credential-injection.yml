rules:
  - id: azure-custom-script-extension-credential-injection
    message: |
      Credentials detected in custom script extension settings.
      
      Custom script extensions execute with high privileges (LocalSystem/root).
      Hardcoded credentials in the extension settings or script downloads
      enable complete VM compromise and lateral movement.
      
      Remediation:
      1. Use managed identity to authenticate instead of credentials
      2. If custom script required, fetch secrets from Azure Key Vault at runtime
      3. Use protectedSettings (encrypted) instead of plain settings
      4. Avoid passing credentials as shell variables to scripts
      
      Reference: https://learn.microsoft.com/en-us/azure/virtual-machines/extensions/custom-script-linux
    severity: ERROR
    languages: [terraform, json]
    pattern-either:
      - pattern-regex:
          regex: 'settings\s*=\s*jsonencode\s*\(\s*{[^}]*(?:password|secret|key|token|credential)[^}]*:.*["\'][^"\']*["\'][^}]*}\s*\)'
          message: "Credentials in custom script extension settings"
      - pattern-regex:
          regex: 'command_to_execute.*(?:password|secret|key|token|credential)\s*=\s*"[^"]*"'
          message: "Credentials in custom script execution command"
      - pattern-regex:
          regex: 'protected_settings.*password|protected_settings.*secret'
          message: "Protected settings should use Key Vault references, not inline secrets"
    metadata:
      cwe: "CWE-798: Use of Hard-Coded Credentials"
      owasp: "A02:2021 â€“ Cryptographic Failures"
      severity-score: 9.0
      resource-type: "azurerm_virtual_machine_extension"
      detection-method: "Pattern matching for credential patterns in extension settings"
      remediation-time: "1-2 hours"
