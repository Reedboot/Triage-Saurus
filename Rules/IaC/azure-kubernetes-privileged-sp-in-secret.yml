rules:
  - id: azure-kubernetes-privileged-sp-in-secret
    message: |
      Kubernetes secret stores Service Principal credentials with broad
      permissions (Contributor/Owner). If pod is compromised, attacker gains
      full environment access. Use Managed Identity instead.
    severity: WARNING
    languages: [terraform, hcl]
    patterns:
      - pattern: |
          resource "kubernetes_secret_v1" "$NAME" {
            ...
            data = {
              ...
              secret = $SP_SECRET
              ...
            }
            ...
          }
      - metavariable-regex:
          metavariable: $SP_SECRET
          regex: .*service_principal.*
    metadata:
      category: security
      subcategory: [secrets, cloud, kubernetes]
      cwe: CWE-522
      confidence: MEDIUM
      likelihood: MEDIUM
      impact: HIGH
      technology: [terraform, azure, kubernetes]
