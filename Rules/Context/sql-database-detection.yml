rules:
  - id: context-azure-sql-database
    message: |
      Azure SQL Database detected in infrastructure.
    severity: INFO
    languages: [terraform, hcl]
    pattern-either:
      - pattern: |
          resource "azurerm_mssql_database" $NAME {
            ...
            server_id = $SERVER
            ...
          }
      - patterns:
          - pattern: |
              module $MOD {
                ...
                source = $SRC
                ...
              }
          - metavariable-regex:
              metavariable: $SRC
              regex: "(?i).*(mssql|sql)[_-]?database.*"
    metadata:
      rule_type: context_discovery
      category: infrastructure
      subcategory: sql_database
      technology: [terraform, azure, sql_database]
      target_files: ["*.tf", "**/*.tf"]
      extracts:
        service_type: SQL Database
        resource_type: azurerm_mssql_database
        resource_name: $NAME
        properties:
          - name: server_id
            pattern: server_id = $SERVER
          - name: sku_name
            pattern: sku_name = "$SKU"
          - name: max_size_gb
            pattern: max_size_gb = $MAX_SIZE
          - name: auto_pause_delay_in_minutes
            pattern: auto_pause_delay_in_minutes = $AUTO_PAUSE
    description: |
      Detects Azure SQL Database resources (including modules) and captures the parent SQL server reference via server_id for linkage.
