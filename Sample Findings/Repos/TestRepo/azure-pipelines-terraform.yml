trigger:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

variables:
  # Name of your Azure DevOps Service Connection.
  azureServiceConnection: ""

  # Object ID of the pipeline identity (service connection SP/managed identity).
  pipelinePrincipalObjectId: ""

  # Set these as pipeline variables (or variable group) for your remote state.
  tfstate_container: "tfstate"
  tfstate_key: "testrepo.tfstate"

  # App variables
  location: "eastus"
  name_prefix: "demo"

stages:
  - stage: terraform
    displayName: Terraform Apply
    jobs:
      - job: apply
        displayName: Apply
        steps:
          - checkout: self

          - task: AzureCLI@2
            displayName: Bootstrap remote state (Storage Account)
            inputs:
              azureSubscription: "$(azureServiceConnection)"
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -euo pipefail

                if ! command -v terraform >/dev/null 2>&1; then
                  echo "Terraform not found; installing to /tmp..."
                  TF_VERSION="1.7.5"
                  curl -sSLo /tmp/terraform.zip "https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip"
                  unzip -o /tmp/terraform.zip -d /tmp >/dev/null
                  export PATH="/tmp:${PATH}"
                fi

                terraform -version

                terraform -chdir=terraform/state init -backend=false
                terraform -chdir=terraform/state apply -auto-approve \
                  -var="location=$(location)" \
                  -var="name_prefix=$(name_prefix)" \
                  -var="tfstate_container=$(tfstate_container)" \
                  -var="pipeline_principal_object_id=$(pipelinePrincipalObjectId)"

                TFSTATE_RG="$(terraform -chdir=terraform/state output -raw tfstate_resource_group_name)"
                TFSTATE_SA="$(terraform -chdir=terraform/state output -raw tfstate_storage_account_name)"
                TFSTATE_CONTAINER="$(terraform -chdir=terraform/state output -raw tfstate_container_name)"

                echo "##vso[task.setvariable variable=tfstate_rg]${TFSTATE_RG}"
                echo "##vso[task.setvariable variable=tfstate_storage]${TFSTATE_SA}"
                echo "##vso[task.setvariable variable=tfstate_container]${TFSTATE_CONTAINER}"

          - task: AzureCLI@2
            displayName: Terraform init/plan/apply (app infrastructure)
            inputs:
              azureSubscription: "$(azureServiceConnection)"
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -euo pipefail

                if ! command -v terraform >/dev/null 2>&1; then
                  echo "Terraform not found; installing to /tmp..."
                  TF_VERSION="1.7.5"
                  curl -sSLo /tmp/terraform.zip "https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip"
                  unzip -o /tmp/terraform.zip -d /tmp >/dev/null
                  export PATH="/tmp:${PATH}"
                fi

                cd terraform

                terraform -version

                terraform init \
                  -backend-config="resource_group_name=$(tfstate_rg)" \
                  -backend-config="storage_account_name=$(tfstate_storage)" \
                  -backend-config="container_name=$(tfstate_container)" \
                  -backend-config="key=$(tfstate_key)" \
                  -backend-config="use_azuread_auth=true"

                terraform plan -out=tfplan \
                  -var="location=$(location)" \
                  -var="name_prefix=$(name_prefix)"

                terraform apply -auto-approve tfplan

          - task: AzureCLI@2
            displayName: Capture Terraform outputs
            inputs:
              azureSubscription: "$(azureServiceConnection)"
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -euo pipefail
                cd terraform

                terraform output -json > tfoutputs.json
                cat tfoutputs.json

          - publish: terraform/tfoutputs.json
            displayName: Publish tfoutputs.json
            artifact: tfoutputs
